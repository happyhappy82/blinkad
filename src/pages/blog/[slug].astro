---
import Layout from '../../layouts/Layout.astro';
import { BLOG_POSTS } from '../../constants';

export function getStaticPaths() {
  return BLOG_POSTS.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;

// Get related posts (same category, excluding current)
const relatedPosts = BLOG_POSTS
  .filter((p) => p.id !== post.id && p.category === post.category)
  .slice(0, 2);

// Date formatting
const dateForISO = post.date.replace(/\./g, '-');
const publishedTime = `${dateForISO}T00:00:00+09:00`;

// Site URL
const siteUrl = "https://blinkad.co.kr";
const articleUrl = `${siteUrl}/blog/${post.id}`;

// Extract FAQ from content if exists
function extractFAQ(content: string): Array<{question: string, answer: string}> {
  const faqs: Array<{question: string, answer: string}> = [];
  const qPattern = /Q\.\s*(.+?)(?=<\/p>|<br|A\.)/g;
  const aPattern = /A\.\s*(.+?)(?=<\/p>|<br|Q\.)/g;

  const questions = content.match(/Q\.\s*[^<]+/g) || [];
  const answers = content.match(/A\.\s*[^<]+/g) || [];

  for (let i = 0; i < Math.min(questions.length, answers.length); i++) {
    faqs.push({
      question: questions[i].replace(/Q\.\s*/, '').trim(),
      answer: answers[i].replace(/A\.\s*/, '').trim()
    });
  }
  return faqs;
}

const faqs = extractFAQ(post.content);

// Article Schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.title,
  "description": post.excerpt || post.title,
  "image": post.imageUrl,
  "datePublished": publishedTime,
  "dateModified": publishedTime,
  "author": {
    "@type": "Organization",
    "name": "Blink Ad",
    "url": siteUrl
  },
  "publisher": {
    "@type": "Organization",
    "name": "Blink Ad",
    "logo": {
      "@type": "ImageObject",
      "url": `${siteUrl}/favicon.svg`
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": articleUrl
  },
  "articleSection": post.category,
  "inLanguage": "ko-KR"
};

// FAQ Schema (if FAQs exist)
const faqSchema = faqs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
} : null;

// BreadcrumbList Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "홈",
      "item": siteUrl
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "블로그",
      "item": `${siteUrl}/blog`
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": post.title,
      "item": articleUrl
    }
  ]
};
---

<Layout
  title={`${post.title} - Blink Ad`}
  description={post.excerpt || post.title}
  image={post.imageUrl}
  type="article"
  publishedTime={publishedTime}
  canonical={articleUrl}
>
  <!-- Article Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <!-- Breadcrumb Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <!-- FAQ Schema (if exists) -->
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}

  <div class="min-h-screen bg-black text-white">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-black/80 backdrop-blur-md border-b border-white/5">
      <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
        <a href="/" class="text-xl font-semibold tracking-tight hover:text-gray-300 transition-colors">Blink Ad</a>
        <div class="flex items-center gap-8">
          <a href="/" class="text-sm text-gray-400 hover:text-white transition-colors">Home</a>
          <a href="/services" class="text-sm text-gray-400 hover:text-white transition-colors">서비스</a>
          <a href="/case-studies" class="text-sm text-gray-400 hover:text-white transition-colors">성공사례</a>
          <a href="/blog" class="text-sm text-gray-400 hover:text-white transition-colors">Blog</a>
        </div>
      </div>
    </nav>

    <!-- Article -->
    <article class="pt-24 pb-16">
      <!-- Header -->
      <header class="max-w-4xl mx-auto px-6 mb-12">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-6">
          <ol class="flex items-center text-sm text-gray-500">
            <li><a href="/" class="hover:text-white transition-colors">홈</a></li>
            <li class="mx-2">/</li>
            <li><a href="/blog" class="hover:text-white transition-colors">블로그</a></li>
            <li class="mx-2">/</li>
            <li class="text-gray-400 truncate max-w-[200px]">{post.title}</li>
          </ol>
        </nav>

        <a href="/blog" class="inline-flex items-center text-gray-500 hover:text-white text-sm mb-8 transition-colors">
          <span class="mr-2">←</span>
          블로그로 돌아가기
        </a>

        {post.category && (
          <span class="inline-block px-3 py-1 bg-brand-blue/20 text-brand-blue text-sm font-medium rounded-full mb-4">
            {post.category}
          </span>
        )}

        <h1 class="text-4xl md:text-5xl font-bold mb-6 keep-all leading-tight">
          {post.title}
        </h1>

        <div class="flex items-center gap-4 text-gray-500 text-sm">
          <time datetime={publishedTime}>{post.date}</time>
        </div>
      </header>

      <!-- Featured Image -->
      <div class="max-w-5xl mx-auto px-6 mb-12">
        <div class="aspect-video rounded-2xl overflow-hidden">
          <img
            src={post.imageUrl}
            alt={post.title}
            class="w-full h-full object-cover"
            loading="eager"
            decoding="async"
          />
        </div>
      </div>

      <!-- Content -->
      <main class="max-w-3xl mx-auto px-6">
        <div class="prose prose-invert prose-lg max-w-none blog-content" set:html={post.content} />
      </main>
    </article>

    <!-- CTA Section -->
    <section class="py-16 border-t border-white/10">
      <div class="max-w-4xl mx-auto px-6 text-center">
        <h2 class="text-3xl font-bold mb-4 keep-all">비즈니스 성장을 원하시나요?</h2>
        <p class="text-gray-400 mb-8 keep-all">전문 SEO 컨설팅으로 검색 결과 1페이지를 선점하세요.</p>
        <a
          href="/#contact"
          class="inline-flex items-center justify-center px-8 py-4 bg-brand-blue text-white font-semibold rounded-full hover:bg-blue-600 transition-colors"
        >
          무료진단 신청하기
        </a>
      </div>
    </section>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <aside class="py-16 border-t border-white/10">
        <div class="max-w-6xl mx-auto px-6">
          <h2 class="text-2xl font-bold mb-8">관련 글</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {relatedPosts.map((relatedPost) => (
              <a href={`/blog/${relatedPost.id}`} class="group block">
                <article class="bg-white/5 rounded-xl overflow-hidden border border-white/10 hover:border-white/20 transition-all">
                  <div class="aspect-video relative overflow-hidden">
                    <img
                      src={relatedPost.imageUrl}
                      alt={relatedPost.title}
                      class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                  <div class="p-6">
                    <time class="text-sm text-gray-500" datetime={relatedPost.date.replace(/\./g, '-')}>{relatedPost.date}</time>
                    <h3 class="text-lg font-semibold mt-2 group-hover:text-brand-blue transition-colors keep-all">
                      {relatedPost.title}
                    </h3>
                  </div>
                </article>
              </a>
            ))}
          </div>
        </div>
      </aside>
    )}

    <!-- Footer -->
    <footer class="border-t border-white/10 py-12">
      <div class="max-w-7xl mx-auto px-6 text-center">
        <a href="/" class="text-xl font-semibold tracking-tight mb-4 inline-block">Blink Ad</a>
        <p class="text-gray-500 text-sm">Premium SEO Agency</p>
        <p class="text-gray-600 text-xs mt-4">&copy; {new Date().getFullYear()} Blink Ad. All rights reserved.</p>
      </div>
    </footer>
  </div>
</Layout>

<style is:global>
  .blog-content {
    color: #e5e5e5;
    line-height: 1.8;
  }

  .blog-content h2 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: #ffffff;
  }

  .blog-content h3 {
    font-size: 1.375rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: #ffffff;
  }

  .blog-content p {
    margin-bottom: 1.5rem;
    word-break: keep-all;
  }

  .blog-content li {
    margin-bottom: 0.5rem;
    padding-left: 1.5rem;
    position: relative;
  }

  .blog-content li::before {
    content: "•";
    position: absolute;
    left: 0;
    color: #0071E3;
  }

  .blog-content a {
    color: #0071E3;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .blog-content a:hover {
    color: #3b9aff;
  }

  .blog-content strong {
    color: #ffffff;
    font-weight: 600;
  }

  .blog-content blockquote {
    border-left: 3px solid #0071E3;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #a0a0a0;
  }

  .blog-content code {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .blog-content pre {
    background: rgba(255, 255, 255, 0.05);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .blog-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
  }

  .blog-content th,
  .blog-content td {
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.75rem;
    text-align: left;
  }

  .blog-content th {
    background: rgba(255, 255, 255, 0.05);
    font-weight: 600;
    white-space: nowrap;
  }

  .blog-content td:first-child {
    white-space: nowrap;
  }
</style>
